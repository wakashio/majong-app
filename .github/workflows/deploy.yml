name: Deploy to Staging

on:
  push:
    branches:
      - staging   # ステージング環境のみ自動デプロイ

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-west1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Authenticate with GCP
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' | gcloud auth activate-service-account --key-file=-
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io
      
      - name: Enable Required APIs
        run: |
          gcloud services enable vpcaccess.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable run.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
          gcloud services enable sqladmin.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }} || true
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      
      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/staging
        run: terraform init
      
      - name: Import existing VPC resources
        working-directory: infrastructure/terraform/environments/staging
        run: |
          # VPCネットワークのインポート（既に存在する場合はエラーを無視）
          terraform import module.vpc.google_compute_network.vpc projects/${{ secrets.GCP_PROJECT_ID }}/global/networks/majong-app-vpc-staging 2>&1 | grep -v "already managed" || true
          
          # サブネットのインポート
          terraform import module.vpc.google_compute_subnetwork.subnet projects/${{ secrets.GCP_PROJECT_ID }}/regions/${{ env.GCP_REGION }}/subnetworks/majong-app-subnet-staging 2>&1 | grep -v "already managed" || true
          
          # プライベートIPのインポート
          terraform import module.vpc.google_compute_global_address.private_ip projects/${{ secrets.GCP_PROJECT_ID }}/global/addresses/majong-app-private-ip-staging 2>&1 | grep -v "already managed" || true
          
          # サービスネットワーキング接続のインポート（存在する場合）
          terraform import module.vpc.google_service_networking_connection.private_vpc_connection projects/${{ secrets.GCP_PROJECT_ID }}/global/networks/majong-app-vpc-staging:servicenetworking.googleapis.com 2>&1 | grep -v "already managed" || true
        continue-on-error: true
      
      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/staging
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_db_user: ${{ secrets.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_frontend_image: gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-frontend:${{ github.sha }}
          TF_VAR_backend_image: gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-backend:${{ github.sha }}
        run: |
          # 状態を確認して、VPCネットワークが存在するかチェック
          if terraform state list | grep -q "module.vpc.google_compute_network.vpc"; then
            echo "VPC network exists in state, applying all resources..."
            terraform apply -auto-approve
          else
            echo "VPC network not in state, applying without VPC module first..."
            # VPCモジュールを除外して適用
            terraform apply -auto-approve -target=module.cloud_sql -target=module.backend -target=module.frontend -target=time_sleep.wait_for_vpc_connection || true
            # その後、VPCを再度インポートしてから全体を適用
            terraform import module.vpc.google_compute_network.vpc projects/${{ secrets.GCP_PROJECT_ID }}/global/networks/majong-app-vpc-staging || true
            terraform apply -auto-approve
          fi
      
      - name: Build and push Frontend
        run: |
          cd frontend
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-frontend:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-frontend:latest .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-frontend:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-frontend:latest
      
      - name: Build and push Backend
        run: |
          cd backend
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-backend:${{ github.sha }} .
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-backend:latest .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-backend:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-backend:latest
      
      - name: Get Cloud SQL Connection Name
        id: cloud_sql_connection
        run: |
          CONNECTION_NAME=$(gcloud sql instances describe majong-app-db-staging \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(connectionName)')
          echo "connection_name=$CONNECTION_NAME" >> $GITHUB_OUTPUT
          echo "Cloud SQL Connection Name: $CONNECTION_NAME"
      
      - name: Grant Cloud SQL Client Permission to Cloud Run Service Account
        run: |
          # Get the default Compute Engine service account email
          PROJECT_NUMBER=$(gcloud projects describe ${{ secrets.GCP_PROJECT_ID }} --format='value(projectNumber)')
          SERVICE_ACCOUNT_EMAIL="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"
          
          # Grant Cloud SQL Client role to the service account
          gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID }} \
            --member="serviceAccount:${SERVICE_ACCOUNT_EMAIL}" \
            --role="roles/cloudsql.client" \
            --condition=None || echo "Permission may already be granted or service account may not exist"
          
          echo "Granted roles/cloudsql.client to ${SERVICE_ACCOUNT_EMAIL}"
      
      - name: Run Database Migrations
        run: |
          # Cloud Run Jobを作成/更新してマイグレーションを実行
          gcloud run jobs deploy majong-app-migrate-staging \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-backend:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --set-cloudsql-instances ${{ steps.cloud_sql_connection.outputs.connection_name }} \
            --set-env-vars "NODE_ENV=staging,DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@/majong_db?host=/cloudsql/${{ steps.cloud_sql_connection.outputs.connection_name }}" \
            --vpc-connector staging-connector \
            --vpc-egress all-traffic \
            --command "npx" \
            --args "prisma,migrate,deploy" \
            --execute-now \
            --wait || echo "Migration job may have failed, but continuing deployment"
        continue-on-error: true
      
      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy majong-app-backend-staging \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-backend:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-cloudsql-instances ${{ steps.cloud_sql_connection.outputs.connection_name }} \
            --set-env-vars "NODE_ENV=staging,DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@/majong_db?host=/cloudsql/${{ steps.cloud_sql_connection.outputs.connection_name }}" \
            --vpc-connector staging-connector \
            --vpc-egress all-traffic \
            --cpu 1 \
            --memory 512Mi \
            --min-instances 0 \
            --max-instances 1
      
      - name: Get Backend URL
        id: backend_url
        run: |
          BACKEND_URL=$(gcloud run services describe majong-app-backend-staging --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $BACKEND_URL"
      
      - name: Update Backend Environment Variables with API URL
        run: |
          gcloud run services update majong-app-backend-staging \
            --region ${{ env.GCP_REGION }} \
            --update-env-vars "API_BASE_URL=${{ steps.backend_url.outputs.url }}"
      
      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy majong-app-frontend-staging \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/majong-app-frontend:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=staging,VITE_API_BASE_URL=${{ steps.backend_url.outputs.url }}" \
            --cpu 1 \
            --memory 512Mi \
            --min-instances 0 \
            --max-instances 1 \
            --port 80
      
      - name: Deployment Summary
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Backend: $(gcloud run services describe majong-app-backend-staging --region ${{ env.GCP_REGION }} --format 'value(status.url)')"
          echo "Frontend: $(gcloud run services describe majong-app-frontend-staging --region ${{ env.GCP_REGION }} --format 'value(status.url)')"

