# 打点計算ロジック設計書

## 概要

麻雀の打点計算ロジックの設計書です。ツモ、ロン、流局の結果に基づいて、各参加者の打点を自動計算します。

## 計算ルール

### 基本ルール

1. **親子の判定**
   - 親は`dealerPlayerId`で指定された参加者
   - 子は親以外の参加者

2. **本場（honba）**
   - 親が上がった場合、次の局で本場が1増加
   - 子が上がった場合、本場はリセット（0に戻る）
   - 流局時、親がテンパイしている場合は本場が1増加

3. **積み棒（riichiSticks）**
   - リーチ宣言時に1000点を供託
   - 和了者が積み棒を獲得
   - 流局時は積み棒が次局に持ち越される

### ツモの打点計算

#### 親がツモした場合

- 子1人あたり: `(基本点 × 2) + (本場 × 300)`
- 基本点 = `fu × 2^(han+2)`
- 1000点未満は切り上げ（100点単位）

#### 子がツモした場合

- 親から: `(基本点 × 2) + (本場 × 300)`
- 子から: `(基本点 × 1) + (本場 × 100)`
- 基本点 = `fu × 2^(han+2)`
- 1000点未満は切り上げ（100点単位）

#### 積み棒の分配

- ツモ: 和了者が積み棒を獲得（和了者は1人のみ）
- ロン（通常）: 和了者が積み棒を獲得（和了者は1人のみ）
- ロン（ダブロン・トリロン）: 放銃者から見て最も近い上家のみが積み棒を獲得
  - 上家の計算方法: `seatPosition`を使用（0=東、1=南、2=西、3=北）
  - 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
- 積み棒1本 = 1000点

### ロンの打点計算

#### 親がロンした場合

- 放銃者から: `(基本点 × 6) + (本場 × 300)`
- 基本点 = `fu × 2^(han+2)`
- 1000点未満は切り上げ（100点単位）

#### 子がロンした場合

- 放銃者が親の場合: `(基本点 × 6) + (本場 × 300)`
- 放銃者が子の場合: `(基本点 × 4) + (本場 × 300)`
- 基本点 = `fu × 2^(han+2)`
- 本場の計算は親子の差はない（常に本場 × 300点）

#### ダブロン・トリロン時の本場の分配

- 通常のロン（和了者1人）: 和了者が本場の点数を受け取る
  - 和了者は`+本場 × 300`点を獲得（親子の差はない）
  - 放銃者は`-本場 × 300`点を支払う（親子の差はない）
- ダブロン・トリロン（和了者2人以上）: 放銃者から見て最も近い上家のみが本場の点数を受け取る
  - 上家の計算方法: `seatPosition`を使用（0=東、1=南、2=西、3=北）
  - 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
  - 最も近い上家は`+本場 × 300`点を獲得（親子の差はない）
  - 放銃者は`-本場 × 300`点を支払う（親子の差はない）

#### 積み棒の分配（ロン）

- 通常のロン（和了者1人）: 和了者が積み棒を獲得
- ダブロン・トリロン（和了者2人以上）: 放銃者から見て最も近い上家のみが積み棒を獲得
  - 上家の計算方法: `seatPosition`を使用（0=東、1=南、2=西、3=北）
  - 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
- 積み棒1本 = 1000点

### 流局の打点計算

#### 通常の流局（荒牌流局）

- 点数変動なし（0）
- 積み棒は次局に持ち越される
- 親がテンパイしている場合、本場が1増加

#### 流し満貫

- 各参加者から2000点を徴収
- 合計8000点を獲得
- 積み棒は次局に持ち越される

#### 特殊流局（四槓、四風、九種九牌）

- 点数変動なし（0）
- 積み棒は次局に持ち越される
- 親がテンパイしている場合、本場が1増加（連荘になる）
- 親がノーテンで全員ノーテンの場合、本場が1増加（連荘にはならない）
- 親がノーテンで全員ノーテンでない場合、本場は増加しない

## 計算式

### 基本点の計算

```
基本点 = fu × 2^(han+2)
```

ただし、以下の上限・下限があります：
- 上限: 2000点（満貫）、4000点（跳満）、6000点（倍満）、8000点（三倍満）、12000点（役満）
- 下限: 1000点（100点単位で切り上げ）

### 打点の計算

#### ツモ（親）

```
打点 = (基本点 × 2) + (本場 × 300) + 積み棒
```

#### ツモ（子）

```
親から: (基本点 × 2) + (本場 × 300)
子から: (基本点 × 1) + (本場 × 100)
合計 = 親から + 子から × 2 + 積み棒
```

#### ロン（親）

```
打点 = (基本点 × 6) + (本場 × 300) + 積み棒
```

#### ロン（子、親から）

```
打点 = (基本点 × 6) + (本場 × 300) + 積み棒
```

#### ロン（子、子から）

```
打点 = (基本点 × 4) + (本場 × 300) + 積み棒
```

注: 本場の計算は親子の差はない（常に本場 × 300点）

## ダブロン・トリロン時のルール

### ダブロン・トリロンの判定

- ロン（`resultType === RoundResultType.RON`）かつ和了者が2人以上の場合にダブロン・トリロンと判定
- ダブロン: 和了者が2人
- トリロン: 和了者が3人

### 上家の計算方法

- `seatPosition`を使用（0=東、1=南、2=西、3=北）
- 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
- 例: 放銃者が東（0）の場合、上家は北（3）

### 積み棒の分配

- ダブロン・トリロン時は、放銃者から見て最も近い上家のみが積み棒を獲得
- 他の和了者は積み棒を獲得しない

### 本場の点数分配

- ダブロン・トリロン時は、放銃者から見て最も近い上家のみが本場の点数を受け取る
- 他の和了者は本場の点数を受け取らない
- 放銃者からは通常通り本場の点数が減算される

## 実装方針

### 計算ロジックの集約方針

点数計算ロジックをバックエンドの`scoreCalculationService.ts`に集約し、フロントエンドの計算ロジックを削除または簡素化する。

#### バックエンド

- `backend/src/services/scoreCalculationService.ts`を単一のソースとして使用
- `backend/src/services/roundService.ts`の`endRound`関数で`scoreCalculationService.ts`の関数を呼び出す
- `hanchanPlayers`を取得する際に、`seatPosition`も含める
- ダブロン判定のヘルパー関数を作成（オプション）
- 型安全性を確保

#### フロントエンド

- **削除する機能**:
  - `ResultInputDialog.vue`の確定前プレビュー表示（積み棒・本場による点数変動、局収支）を削除
  - `useScoreCalculation.ts`の`getRiichiHonbaScoreChange`、`getTotalScoreChange`関数を削除（結果入力ダイアログ用）
  - `useResultInput.ts`の計算ロジックを削除または簡素化

- **残す機能**:
  - `useScoreCalculation.ts`の打点記録テーブル表示用の関数（`getRiichiSticksScoreChangeForTable`、`getHonbaScoreChangeForTable`）は残す
  - 確定後にDBから取得したデータを表示する機能

#### UIの変更

- 確定前のプレビュー表示を削除
- 確定ボタン押下時にバックエンドAPI（`endRound`）で計算・保存
- 確定後、DBから取得したデータを打点記録テーブルに表示

### サービス層

- `backend/src/services/roundService.ts`の`endRound`関数に実装
- `hanchanPlayers`を取得する際に、`seatPosition`も含める
- ダブロン判定のヘルパー関数を作成（オプション）
- 型安全性を確保

### 関数設計

```typescript
// 基本点を計算
function calculateBaseScore(han: number, fu: number): number;

// ツモの打点を計算
function calculateTsumoScore(
  baseScore: number,
  honba: number,
  riichiSticks: number,
  isDealer: boolean
): {
  winnerScore: number;
  loserScores: number[];
};

// ロンの打点を計算
function calculateRonScore(
  baseScore: number,
  honba: number,
  riichiSticks: number,
  isDealer: boolean,
  isTargetDealer: boolean
): {
  winnerScore: number;
  loserScore: number;
};

// 流局の打点を計算
function calculateDrawScore(
  resultType: RoundResultType,
  isNagashiMangan: boolean
): {
  scores: number[];
};
```

### エラーハンドリング

- 無効な入力値の場合はエラーを返す
- 計算結果が範囲外の場合はエラーを返す
- エラーメッセージは日本語で記述

## テスト方針

- 正常系のテスト（ツモ、ロン、流局）
- 異常系のテスト（無効な入力値）
- エッジケースのテスト（満貫、跳満、倍満、三倍満、役満）
- 本場・積み棒の計算テスト
- ダブロン時のテスト
  - ダブロン時の積み棒分配のテスト
  - ダブロン時の本場点数計算のテスト
  - トリロン時のテスト
  - 通常のロン（和了者1人）時のテスト（既存の動作が壊れていないことを確認）

## 関連ドキュメント

- `design/api/rounds-calculate-score.md`: 打点計算API
- `design/api/rounds-end.md`: 局終了API
- `design/mahjong-data-model.md`: データモデル設計書

