# 打点計算ロジック設計書

## 概要

麻雀の打点計算ロジックの設計書です。ツモ、ロン、流局の結果に基づいて、各参加者の打点を自動計算します。

## 計算ルール

### 基本ルール

1. **親子の判定**
   - 親は`dealerPlayerId`で指定された参加者
   - 子は親以外の参加者

2. **本場（honba）**
   - 親が上がった場合、次の局で本場が1増加
   - 子が上がった場合、本場はリセット（0に戻る）
   - 流局時、親がテンパイしている場合は本場が1増加

3. **積み棒（riichiSticks）**
   - リーチ宣言時に1000点を供託
   - 和了者が積み棒を獲得
   - 流局時は積み棒が次局に持ち越される

### ツモの打点計算

ツモ時の打点計算は、点数表を使用して行います。点数表には本場・積み棒は含まれず、別途計算して加算します。

#### 点数表の構造

点数表はツモ時のみ使用し、ロン時は使用しません（ロン時は和了点 = 放銃者の支払い点数そのまま）。

**点数表の範囲**: 1000点〜144000点（トリプル役満まで）
- 子が和了: 最大96000点
- 親が和了: 最大144000点

**点数表のデータ構造**:

```typescript
interface TsumoScoreTable {
  // 親がツモした場合
  dealer: {
    [totalScore: number]: {
      fromNonDealer: number; // 子1人あたりの支払い点数（本場・積み棒除く）
    };
  };
  // 子がツモした場合
  nonDealer: {
    [totalScore: number]: {
      fromDealer: number;    // 親からの支払い点数（本場・積み棒除く）
      fromNonDealer: number; // 子からの支払い点数（本場・積み棒除く）
    };
  };
}
```

**上がり点のラベル**:

プルダウンで点数を選択する際に、点数とともにラベルを表示します。ラベルの形式は以下の通りです:

- **親がツモした場合**: 「子1人あたりの点数」+「オール」
  - 例: `1500点（500オール）`、`3000点（1000オール）`、`12000点（4000オール）`
- **子がツモした場合**: 「子からの点数」+「/」+「親からの点数」
  - 例: `1100点（300/500）`、`2000点（500/1000）`、`8000点（2000/4000）`

ラベルの表示例（親がツモ）:
- `1500点（500オール）`
- `3000点（1000オール）`
- `8000点（2600オール）`
- `12000点（4000オール）`
- `32000点（10600オール）`
- `144000点（48000オール）`

ラベルの表示例（子がツモ）:
- `1100点（300/500）`
- `2000点（500/1000）`
- `8000点（2000/4000）`
- `12000点（3000/6000）`
- `32000点（8000/16000）`
- `96000点（24000/48000）`

**ラベルの実装方針**:

- バックエンドの点数表から、子1人あたりの点数（親がツモ）または親からの点数・子からの点数（子がツモ）を取得
- フロントエンドのプルダウンで、点数とラベルを組み合わせて表示
- ラベルは点数表の値から自動生成する
  - 親がツモ: 「子1人あたりの点数」+「オール」の形式
  - 子がツモ: 「子からの点数」+「/」+「親からの点数」の形式

#### 点数表の詳細

点数表は1000点から144000点（トリプル役満まで）の範囲で定義します。本場・積み棒は含まれません。

**親がツモした場合の点数表**（子1人あたりの支払い点数）:

| 和了点 | 子1人あたり | ラベル |
|--------|------------|--------|
| 1500 | 500 | 500オール |
| 2100 | 700 | 700オール |
| 2400 | 800 | 800オール |
| 3000 | 1000 | 1000オール |
| 3900 | 1300 | 1300オール |
| 4500 | 1500 | 1500オール |
| 4800 | 1600 | 1600オール |
| 5400 | 1800 | 1800オール |
| 6000 | 2000 | 2000オール |
| 6900 | 2300 | 2300オール |
| 7800 | 2600 | 2600オール |
| 8700 | 2900 | 2900オール |
| 9600 | 3200 | 3200オール |
| 10600 | 3600 | 3600オール |
| 12000 | 4000 | 4000オール |
| 18000 | 6000 | 6000オール |
| 24000 | 8000 | 8000オール |
| 36000 | 12000 | 12000オール |
| 48000 | 16000 | 16000オール |
| 96000 | 32000 | 32000オール |
| 144000 | 48000 | 48000オール |

**子がツモした場合の点数表**（親からの支払い点数 / 子からの支払い点数）:

| 和了点 | 親から | 子から | ラベル |
|--------|--------|--------|--------|
| 1100 | 500 | 300 | 300/500 |
| 1500 | 700 | 400 | 400/700 |
| 1600 | 800 | 400 | 400/800 |
| 2000 | 1000 | 500 | 500/1000 |
| 2400 | 1200 | 600 | 600/1200 |
| 2600 | 1300 | 700 | 700/1300 |
| 2900 | 1500 | 800 | 800/1500 |
| 3200 | 1600 | 800 | 800/1600 |
| 3600 | 1800 | 900 | 900/1800 |
| 4000 | 2000 | 1000 | 1000/2000 |
| 4400 | 2300 | 1200 | 1200/2300 |
| 5200 | 2600 | 1300 | 1300/2600 |
| 5600 | 2900 | 1500 | 1500/2900 |
| 6400 | 3200 | 1600 | 1600/3200 |
| 6800 | 3400 | 1700 | 1700/3400 |
| 7200 | 3600 | 1800 | 1800/3600 |
| 8000 | 4000 | 2000 | 2000/4000 |
| 12000 | 6000 | 3000 | 3000/6000 |
| 16000 | 8000 | 4000 | 4000/8000 |
| 24000 | 12000 | 6000 | 6000/12000 |
| 32000 | 16000 | 8000 | 8000/16000 |
| 64000 | 32000 | 16000 | 16000/32000 |
| 96000 | 48000 | 24000 | 24000/48000 |

**注意事項**:
- 上記の点数表は主要な点数のみを記載しています。実装時には1000点から144000点まで、すべての点数を定義する必要があります。
- 点数は100点単位で切り上げられます。
- 満貫（8000点）、跳満（12000点）、倍満（16000点）、三倍満（24000点）、役満（32000点）、ダブル役満（64000点）、トリプル役満（96000点/144000点）は特別な点数として扱われます。

#### 親がツモした場合

- 点数表から和了点に対応する子1人あたりの支払い点数を取得
- 本場・積み棒を別途計算して加算
- 子1人あたりの最終支払い点数 = 点数表の値 + (本場 × 100) + (積み棒 × 0)
- 和了者の最終獲得点数 = 子1人あたりの支払い点数 × 3 + (積み棒 × 1000)

#### 子がツモした場合

- 点数表から和了点に対応する親からの支払い点数と子からの支払い点数を取得
- 本場・積み棒を別途計算して加算
- 親からの最終支払い点数 = 点数表の値 + (本場 × 100) + (積み棒 × 0)
- 子からの最終支払い点数 = 点数表の値 + (本場 × 100) + (積み棒 × 0)
- 和了者の最終獲得点数 = 親からの支払い点数 + 子からの支払い点数 × 2 + (積み棒 × 1000)

#### 積み棒の分配

- ツモ: 和了者が積み棒を獲得（和了者は1人のみ）
- ロン（通常）: 和了者が積み棒を獲得（和了者は1人のみ）
- ロン（ダブロン・トリロン）: 放銃者から見て最も近い上家のみが積み棒を獲得
  - 上家の計算方法: `seatPosition`を使用（0=東、1=南、2=西、3=北）
  - 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
- 積み棒1本 = 1000点

### ロンの打点計算

ロン時の打点計算は点数表を使用せず、和了点 = 放銃者の支払い点数そのままです。本場・積み棒は別途計算して加算します。

#### 親がロンした場合

- 放銃者からの支払い点数 = 和了点（本場・積み棒除く）
- 本場・積み棒を別途計算して加算
- 放銃者の最終支払い点数 = 和了点 + (本場 × 300) + (積み棒 × 1000)
- 和了者の最終獲得点数 = 放銃者の最終支払い点数

#### 子がロンした場合

- 放銃者からの支払い点数 = 和了点（本場・積み棒除く）
- 本場・積み棒を別途計算して加算
- 放銃者の最終支払い点数 = 和了点 + (本場 × 300) + (積み棒 × 1000)
- 和了者の最終獲得点数 = 放銃者の最終支払い点数
- 本場の計算は親子の差はない（常に本場 × 300点）

#### フロントエンドでの実装方針

- **点数入力時の自動計算**:
  - 和了点（本場・積み棒除く）を入力した際に、本場・積み棒を加算して和了者の最終獲得点数と放銃者の最終支払い点数（マイナス）を自動計算
  - `calculateRonScoresFromWinnerScore`関数を使用
  - 計算式:
    - 和了者の最終獲得点数 = 和了点（本場・積み棒除く） + (本場 × 300) + (積み棒 × 1000)
    - 放銃者の最終支払い点数 = -(和了点（本場・積み棒除く） + (本場 × 300))
    - 積み棒は和了者が獲得するだけで、放銃者からは引かない
  - 本場の計算は親子の差はない（常に本場 × 300点）
  - 積み棒の計算は和了者が積み棒を獲得（通常のロンの場合）
  - ダブロン・トリロン時の本場・積み棒の分配は現時点では考慮しない（通常のロンのみ対応）

#### ダブロン・トリロン時の本場の分配

- 通常のロン（和了者1人）: 和了者が本場の点数を受け取る
  - 和了者は`+本場 × 300`点を獲得（親子の差はない）
  - 放銃者は`-本場 × 300`点を支払う（親子の差はない）
- ダブロン・トリロン（和了者2人以上）: 放銃者から見て最も近い上家のみが本場の点数を受け取る
  - 上家の計算方法: `seatPosition`を使用（0=東、1=南、2=西、3=北）
  - 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
  - 最も近い上家は`+本場 × 300`点を獲得（親子の差はない）
  - 放銃者は`-本場 × 300`点を支払う（親子の差はない）

#### 積み棒の分配（ロン）

- 通常のロン（和了者1人）: 和了者が積み棒を獲得
- ダブロン・トリロン（和了者2人以上）: 放銃者から見て最も近い上家のみが積み棒を獲得
  - 上家の計算方法: `seatPosition`を使用（0=東、1=南、2=西、3=北）
  - 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
- 積み棒1本 = 1000点

### 流局の打点計算

#### 通常の流局（荒牌流局）

- 点数変動なし（0）
- 積み棒は次局に持ち越される
- 親がテンパイしている場合、本場が1増加

#### 流し満貫

- 各参加者から2000点を徴収
- 合計8000点を獲得
- 積み棒は次局に持ち越される

#### 特殊流局（四槓、四風、九種九牌）

- 点数変動なし（0）
- 積み棒は次局に持ち越される
- 親がテンパイしている場合、本場が1増加（連荘になる）
- 親がノーテンで全員ノーテンの場合、本場が1増加（連荘にはならない）
- 親がノーテンで全員ノーテンでない場合、本場は増加しない

## 計算式

### 基本点の計算

```
基本点 = fu × 2^(han+2)
```

ただし、以下の上限・下限があります：
- 上限: 2000点（満貫）、4000点（跳満）、6000点（倍満）、8000点（三倍満）、12000点（役満）
- 下限: 1000点（100点単位で切り上げ）

### 打点の計算

#### ツモ（親）

```
打点 = (基本点 × 2) + (本場 × 300) + 積み棒
```

#### ツモ（子）

```
親から: (基本点 × 2) + (本場 × 300)
子から: (基本点 × 1) + (本場 × 100)
合計 = 親から + 子から × 2 + 積み棒
```

#### ロン（親）

```
打点 = (基本点 × 6) + (本場 × 300) + 積み棒
```

#### ロン（子、親から）

```
打点 = (基本点 × 6) + (本場 × 300) + 積み棒
```

#### ロン（子、子から）

```
打点 = (基本点 × 4) + (本場 × 300) + 積み棒
```

注: 本場の計算は親子の差はない（常に本場 × 300点）

## ダブロン・トリロン時のルール

### ダブロン・トリロンの判定

- ロン（`resultType === RoundResultType.RON`）かつ和了者が2人以上の場合にダブロン・トリロンと判定
- ダブロン: 和了者が2人
- トリロン: 和了者が3人

### 上家の計算方法

- `seatPosition`を使用（0=東、1=南、2=西、3=北）
- 上家の`seatPosition = (放銃者のseatPosition + 3) % 4`
- 例: 放銃者が東（0）の場合、上家は北（3）

### 積み棒の分配

- ダブロン・トリロン時は、放銃者から見て最も近い上家のみが積み棒を獲得
- 他の和了者は積み棒を獲得しない

### 本場の点数分配

- ダブロン・トリロン時は、放銃者から見て最も近い上家のみが本場の点数を受け取る
- 他の和了者は本場の点数を受け取らない
- 放銃者からは通常通り本場の点数が減算される

## 実装方針

### 計算ロジックの集約方針

点数計算ロジックをバックエンドの`scoreCalculationService.ts`に集約し、フロントエンドの計算ロジックを削除または簡素化する。

#### バックエンド

- `backend/src/services/scoreCalculationService.ts`を単一のソースとして使用
- `backend/src/services/scoreCalculationService.ts`に点数表を定義（定数として保持）
  - 点数表は`tsumoScoreTable`として定義: `{ dealer: { [score]: { fromNonDealer } }, nonDealer: { [score]: { fromDealer, fromNonDealer } } }`
  - 点数表の範囲: 1000点〜144000点（トリプル役満まで）
- ラベルは点数表の値から生成する
  - 親がツモ: 「子1人あたりの点数」+「オール」の形式（例: "500オール"）
  - 子がツモ: 「子からの点数」+「/」+「親からの点数」の形式（例: "300/500"）
- 上がり点のラベル一覧を取得するAPIまたは関数を提供（フロントエンドでプルダウンの選択肢を生成するため）
- `calculateTsumoScore`関数を修正し、点数表から値を取得する方式に変更
  - 本場・積み棒は別途計算して加算
- ロン時の計算は変更不要（和了点 = 放銃者の支払い点数そのまま）
- `backend/src/services/roundService.ts`の`endRound`関数で`scoreCalculationService.ts`の関数を呼び出す
- `hanchanPlayers`を取得する際に、`seatPosition`も含める
- ダブロン判定のヘルパー関数を作成（オプション）
- 型安全性を確保

#### フロントエンド

- **UI変更**:
  - **ツモ時**:
    - `ResultInputDialog.vue`の点数入力をテキスト入力（v-text-field）からプルダウン（v-select）に変更
    - プルダウンの選択肢は1000点〜144000点（トリプル役満まで。子: 96000点、親: 144000点）
    - プルダウンの表示形式:
      - 親がツモ: `{子1人あたり}オール`（例: "500オール"、"4000オール"）
      - 子がツモ: `{子からの点数}/{親からの点数}`（例: "300/500"、"2000/4000"）
    - ラベルは点数表の値から自動生成（フロントエンドで点数表を保持）
    - 選択した点数（本場・積み棒除く）から、本場・積み棒を加算して各プレイヤーの点数を自動計算
    - `calculateTsumoScoresFromBaseScore`関数を使用して点数を計算
  - **ロン時**:
    - 点数入力をテキスト入力（v-text-field）のまま維持
    - 和了点（本場・積み棒除く）を入力した際に、本場・積み棒を加算して和了者の最終獲得点数と放銃者の最終支払い点数（マイナス）を自動計算
    - `calculateRonScoresFromWinnerScore`関数を使用して点数を計算
    - 計算式:
      - 和了者の最終獲得点数 = 和了点（本場・積み棒除く） + (本場 × 300) + (積み棒 × 1000)
      - 放銃者の最終支払い点数 = -(和了点（本場・積み棒除く） + (本場 × 300) + (積み棒 × 1000))
    - 本場の計算は親子の差はない（常に本場 × 300点）
    - 積み棒の計算は和了者が積み棒を獲得（通常のロンの場合）
    - ダブロン・トリロン時の本場・積み棒の分配は現時点では考慮しない（通常のロンのみ対応）

- **削除する機能**:
  - `ResultInputDialog.vue`の確定前プレビュー表示（積み棒・本場による点数変動、局収支）を削除
  - `useScoreCalculation.ts`の`getRiichiHonbaScoreChange`、`getTotalScoreChange`関数を削除（結果入力ダイアログ用）
  - `useResultInput.ts`の計算ロジックを削除または簡素化

- **残す機能**:
  - `useScoreCalculation.ts`の打点記録テーブル表示用の関数（`getRiichiSticksScoreChangeForTable`、`getHonbaScoreChangeForTable`）は残す
  - 確定後にDBから取得したデータを表示する機能

- **追加する機能**:
  - `ResultInputDialog.vue`に`calculateRonScoresFromWinnerScore`関数を追加
    - 引数: 和了点（本場・積み棒除く）、本場、積み棒、和了者、放銃者、全プレイヤー
    - 和了者の最終獲得点数を計算: 和了点 + (本場 × 300) + (積み棒 × 1000)
    - 放銃者の最終支払い点数を計算: -(和了点 + (本場 × 300) + (積み棒 × 1000))
    - 各プレイヤーの`scoreChange`を返す
  - ロン時の点数入力（`v-text-field`）の`@update:model-value`で、この関数を呼び出す

#### UIの変更

- 点数入力をテキスト入力からプルダウンに変更
- 確定前のプレビュー表示を削除
- 確定ボタン押下時にバックエンドAPI（`endRound`）で計算・保存
- 確定後、DBから取得したデータを打点記録テーブルに表示

### サービス層

- `backend/src/services/roundService.ts`の`endRound`関数に実装
- `hanchanPlayers`を取得する際に、`seatPosition`も含める
- ダブロン判定のヘルパー関数を作成（オプション）
- 型安全性を確保

### 関数設計

```typescript
// 基本点を計算
function calculateBaseScore(han: number, fu: number): number;

// ツモの打点を計算（点数表を使用）
function calculateTsumoScore(
  totalScore: number, // 和了点（本場・積み棒除く）
  honba: number,
  riichiSticks: number,
  isDealer: boolean
): {
  winnerScore: number;
  loserScores: {
    fromDealer: number;
    fromNonDealer: number;
  };
};

// ロンの打点を計算
function calculateRonScore(
  baseScore: number,
  honba: number,
  riichiSticks: number,
  isDealer: boolean,
  isTargetDealer: boolean
): {
  winnerScore: number;
  loserScore: number;
};

// 流局の打点を計算
function calculateDrawScore(
  resultType: RoundResultType,
  isNagashiMangan: boolean
): {
  scores: number[];
};
```

### エラーハンドリング

- 無効な入力値の場合はエラーを返す
- 計算結果が範囲外の場合はエラーを返す
- エラーメッセージは日本語で記述

## テスト方針

- 正常系のテスト（ツモ、ロン、流局）
- 異常系のテスト（無効な入力値）
- エッジケースのテスト（満貫、跳満、倍満、三倍満、役満）
- 本場・積み棒の計算テスト
- ダブロン時のテスト
  - ダブロン時の積み棒分配のテスト
  - ダブロン時の本場点数計算のテスト
  - トリロン時のテスト
  - 通常のロン（和了者1人）時のテスト（既存の動作が壊れていないことを確認）

## 関連ドキュメント

- `design/api/rounds-calculate-score.md`: 打点計算API
- `design/api/rounds-end.md`: 局終了API
- `design/mahjong-data-model.md`: データモデル設計書

